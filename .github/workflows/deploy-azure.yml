name: Deploy to Azure Container Apps

# Required GitHub Environment Secrets (in 'production' environment):
# - AZURE_CREDENTIALS: Service principal JSON
# - APP_SECRET: Application secret key
# - PG_DATABASE_URL: PostgreSQL connection string
# - REDIS_URL: Redis connection string
#
# See .github/DEPLOYMENT.md for detailed setup instructions

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: twentycrm-prod
  AZURE_LOCATION: centralus
  ACR_NAME: twentycrmacr
  CONTAINER_APP_ENV: twentycrm-env
  CONTAINER_APP_NAME: twentycrm-app
  POSTGRES_SERVER: twentycrm-postgres
  REDIS_SERVER: twentycrm-redis-1768504249
  STORAGE_ACCOUNT: twentycrmstorage2026

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production  # Use GitHub Environment Secrets for production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.5.0'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # Skip linting and tests for faster deployment
      # TODO: Enable once CI is stable
      # - name: Lint code
      #   run: |
      #     npx nx run-many -t lint --all --parallel=3
      #
      # - name: Run tests
      #   run: |
      #     npx nx run-many -t test --all --parallel=3 --configuration=ci

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push Docker image
        run: |
          # Login to ACR
          az acr login --name ${{ env.ACR_NAME }}

          # Build and push image
          docker build \
            --build-arg REACT_APP_SERVER_BASE_URL=https://sandbox-crm.neuqa.io \
            -t ${{ env.ACR_NAME }}.azurecr.io/twenty:${{ github.sha }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/twenty:latest \
            -f packages/twenty-docker/twenty/Dockerfile .

          docker push ${{ env.ACR_NAME }}.azurecr.io/twenty:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/twenty:latest

      - name: Deploy to Azure Container Apps
        run: |
          # Update container app with new image
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/twenty:${{ github.sha }} \
            --set-env-vars \
              SERVER_URL=https://sandbox-crm.neuqa.io \
              APP_SECRET=${{ secrets.APP_SECRET }} \
              PG_DATABASE_URL=${{ secrets.PG_DATABASE_URL }} \
              REDIS_URL=${{ secrets.REDIS_URL }} \
              STORAGE_TYPE=local \
              DISABLE_DB_MIGRATIONS=false

      - name: Verify deployment
        run: |
          echo "ðŸ” Checking deployment health..."

          # Wait for Container App to update
          echo "Waiting 45 seconds for deployment to stabilize..."
          sleep 45

          # Get latest active revision
          LATEST_REVISION=$(az containerapp revision list \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "sort_by([?properties.active==\`true\`], &properties.createdTime)[-1].name" \
            -o tsv)

          echo "âœ… Latest active revision: ${LATEST_REVISION}"

          # Check custom domain health
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://sandbox-crm.neuqa.io/healthz || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Deployment successful! Health check passed."
            echo "ðŸŒ Application URL: https://sandbox-crm.neuqa.io"
          else
            echo "âš ï¸ Warning: Health check returned HTTP ${HTTP_CODE}"
            echo "ðŸ“‹ Recent logs:"
            az containerapp logs show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --tail 50 || true
            exit 1
          fi

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment failed!**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production (Azure Container Apps)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://sandbox-crm.neuqa.io" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.ACR_NAME }}.azurecr.io/twenty:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
